/**
 * ClinicPro - Ù†Ø¸Ø§Ù… Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
 * ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
 * @version 1.0.0
 * @author ClinicPro Team
 */

class BookingSystem {
    constructor() {
        this.db = window.clinicDB || null;
        this.config = window.configManager || null;
        this.currentStep = 1;
        this.selectedDoctor = null;
        this.selectedDate = null;
        this.selectedTime = null;
        this.selectedType = null;
        this.patientData = {};
        this.bookingData = {};
        
        this.init();
    }

    /**
     * ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¬Ø²
     */
    async init() {
        console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¬Ø²...');
        
        try {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„Ù†Ø¸Ø§Ù…
            if (!this.db) {
                throw new Error('Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØ§Ø­Ø©');
            }
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ø¬Ø²
            this.setupWizardSteps();
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡
            await this.loadDoctors();
            
            // ØªØ­Ù…ÙŠÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
            this.loadAppointmentTypes();
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…
            this.setupCalendar();
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
            this.setupFormEvents();
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø³Ø±ÙŠØ¹ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„)
            await this.setupQuickBooking();
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            this.updateStepButtons();
            
            console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­');
            
        } catch (error) {
            console.error('âŒ ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¬Ø²:', error);
            this.showError('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¬Ø²', error.message);
        }
    }

    /**
     * Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ø¬Ø²
     */
    setupWizardSteps() {
        // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø®Ø·ÙˆØ§Øª
        const nextButtons = document.querySelectorAll('.next-step');
        const prevButtons = document.querySelectorAll('.prev-step');
        
        nextButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const nextStep = parseInt(button.getAttribute('data-next'));
                this.goToStep(nextStep);
            });
        });
        
        prevButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const prevStep = parseInt(button.getAttribute('data-prev'));
                this.goToStep(prevStep);
            });
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø©
        window.addEventListener('resize', () => {
            this.updateWizardDisplay();
        });
    }

    /**
     * Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø®Ø·ÙˆØ© Ù…Ø¹ÙŠÙ†Ø©
     */
    goToStep(stepNumber) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø®Ø·ÙˆØ©
        if (stepNumber < 1 || stepNumber > 5) return;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        if (!this.validateStep(this.currentStep)) {
            this.showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning');
            return;
        }
        
        // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        this.saveStepData(this.currentStep);
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        this.hideStep(this.currentStep);
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        this.showStep(stepNumber);
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·ÙˆØ§Øª
        this.updateWizardSteps(stepNumber);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        this.currentStep = stepNumber;
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        this.updateStepButtons();
        
        // ØªÙ†ÙÙŠØ° Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø®Ø§ØµØ© Ù„Ù„Ø®Ø·ÙˆØ©
        this.executeStepActions(stepNumber);
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø®Ø·ÙˆØ©
     */
    validateStep(stepNumber) {
        switch (stepNumber) {
            case 1: // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø¨ÙŠØ¨
                return this.selectedDoctor !== null;
                
            case 2: // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®
                return this.selectedDate !== null;
                
            case 3: // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆÙ‚Øª
                return this.selectedTime !== null && this.selectedType !== null;
                
            case 4: // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
                return this.validatePatientForm();
                
            case 5: // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²
                return true;
                
            default:
                return false;
        }
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø±ÙŠØ¶
     */
    validatePatientForm() {
        const form = document.getElementById('patient-form');
        if (!form) return false;
        
        // Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        const requiredFields = ['fullName', 'phone', 'gender', 'reason'];
        let isValid = true;
        
        requiredFields.forEach(fieldName => {
            const field = form.querySelector(`[name="${fieldName}"]`);
            if (field && !field.value.trim()) {
                isValid = false;
                this.markFieldAsInvalid(field);
            }
        });
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªÙØ§Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ·
        const termsCheckbox = form.querySelector('#terms-agreement');
        if (termsCheckbox && !termsCheckbox.checked) {
            isValid = false;
            this.markFieldAsInvalid(termsCheckbox);
        }
        
        return isValid;
    }

    /**
     * ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø­Ù‚Ù„ Ø¹Ù„Ù‰ Ø£Ù†Ù‡ ØºÙŠØ± ØµØ§Ù„Ø­
     */
    markFieldAsInvalid(field) {
        field.classList.add('is-invalid');
        
        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø²
        field.classList.add('shake-animation');
        setTimeout(() => {
            field.classList.remove('shake-animation');
        }, 500);
        
        // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚Ù„
        field.focus();
    }

    /**
     * Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø·ÙˆØ©
     */
    saveStepData(stepNumber) {
        switch (stepNumber) {
            case 1: // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨
                this.saveDoctorData();
                break;
                
            case 2: // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®
                this.saveDateData();
                break;
                
            case 3: // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ù†ÙˆØ¹
                this.saveTimeAndTypeData();
                break;
                
            case 4: // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
                this.savePatientData();
                break;
        }
    }

    /**
     * Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨
     */
    saveDoctorData() {
        if (!this.selectedDoctor) return;
        
        this.bookingData.doctorId = this.selectedDoctor.id;
        this.bookingData.doctorName = this.selectedDoctor.name;
        this.bookingData.doctorSpecialty = this.selectedDoctor.specialty;
        this.bookingData.consultationFee = this.selectedDoctor.consultationFee;
    }

    /**
     * Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®
     */
    saveDateData() {
        if (!this.selectedDate) return;
        
        this.bookingData.date = this.selectedDate;
        
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ Ù…Ù‚Ø±ÙˆØ¡
        const dateObj = new Date(this.selectedDate);
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        this.bookingData.formattedDate = dateObj.toLocaleDateString('ar-EG', options);
        this.bookingData.dayName = this.getArabicDayName(dateObj);
    }

    /**
     * Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ù†ÙˆØ¹
     */
    saveTimeAndTypeData() {
        if (!this.selectedTime || !this.selectedType) return;
        
        this.bookingData.time = this.selectedTime;
        this.bookingData.type = this.selectedType.name;
        this.bookingData.typeId = this.selectedType.id;
        this.bookingData.duration = this.selectedType.duration;
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ©
        this.calculateAppointmentFee();
    }

    /**
     * Ø­Ø³Ø§Ø¨ Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ÙˆØ¹Ø¯
     */
    calculateAppointmentFee() {
        let baseFee = this.selectedDoctor?.consultationFee || 0;
        let typeFee = this.selectedType?.price || 0;
        
        this.bookingData.fee = baseFee + typeFee;
        this.bookingData.formattedFee = this.formatCurrency(this.bookingData.fee);
    }

    /**
     * Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
     */
    savePatientData() {
        const form = document.getElementById('patient-form');
        if (!form) return;
        
        const formData = new FormData(form);
        this.patientData = Object.fromEntries(formData);
        
        // Ø¯Ù…Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²
        this.bookingData.patient = this.patientData;
    }

    /**
     * Ø¥Ø®ÙØ§Ø¡ Ø®Ø·ÙˆØ©
     */
    hideStep(stepNumber) {
        const stepContent = document.querySelector(`.wizard-step-content[data-step="${stepNumber}"]`);
        if (stepContent) {
            stepContent.classList.remove('active');
            stepContent.style.display = 'none';
        }
    }

    /**
     * Ø¹Ø±Ø¶ Ø®Ø·ÙˆØ©
     */
    showStep(stepNumber) {
        const stepContent = document.querySelector(`.wizard-step-content[data-step="${stepNumber}"]`);
        if (stepContent) {
            stepContent.classList.add('active');
            stepContent.style.display = 'block';
            
            // ØªÙ…Ø±ÙŠØ± Ø³Ù„Ø³Ù„Ø© Ù„Ù„Ø¹Ù†ØµØ±
            stepContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ø¬Ø²
     */
    updateWizardSteps(currentStep) {
        const steps = document.querySelectorAll('.wizard-step');
        
        steps.forEach(step => {
            const stepNumber = parseInt(step.getAttribute('data-step'));
            
            // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª
            step.classList.remove('active', 'completed');
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
            if (stepNumber === currentStep) {
                step.classList.add('active');
            } else if (stepNumber < currentStep) {
                step.classList.add('completed');
            }
        });
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø®Ø·ÙˆØ§Øª
     */
    updateStepButtons() {
        const currentStep = this.currentStep;
        
        // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± "Ø§Ù„ØªØ§Ù„ÙŠ"
        const nextButtons = document.querySelectorAll('.next-step');
        nextButtons.forEach(button => {
            const nextStep = parseInt(button.getAttribute('data-next'));
            
            if (nextStep === currentStep + 1) {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø²Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…Ø¹Ø·Ù„Ø§Ù‹
                button.disabled = !this.validateStep(currentStep);
            }
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± "Ø§Ù„Ø³Ø§Ø¨Ù‚"
        const prevButtons = document.querySelectorAll('.prev-step');
        prevButtons.forEach(button => {
            const prevStep = parseInt(button.getAttribute('data-prev'));
            
            if (prevStep === currentStep - 1) {
                button.disabled = false;
            }
        });
    }

    /**
     * ØªÙ†ÙÙŠØ° Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø®Ø§ØµØ© Ù„Ù„Ø®Ø·ÙˆØ©
     */
    executeStepActions(stepNumber) {
        switch (stepNumber) {
            case 1:
                this.updateDoctorSelection();
                break;
                
            case 2:
                this.updateDateSelection();
                break;
                
            case 3:
                this.updateTimeSelection();
                break;
                
            case 4:
                this.updatePatientForm();
                break;
                
            case 5:
                this.updateConfirmation();
                break;
        }
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø¨ÙŠØ¨
     */
    updateDoctorSelection() {
        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø®ØªØ§Ø± ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ© 2
        if (this.selectedDoctor) {
            this.updateSelectedDoctorInfo();
        }
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®
     */
    updateDateSelection() {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ù…Ø¹ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø®ØªØ§Ø±
        if (this.selectedDoctor) {
            this.updateCalendarWithDoctorSchedule();
        }
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆÙ‚Øª
     */
    updateTimeSelection() {
        if (this.selectedDoctor && this.selectedDate) {
            // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø®ØªØ§Ø±
            this.updateSelectedDateInfo();
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
            this.loadAvailableTimeSlots();
        }
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø±ÙŠØ¶
     */
    updatePatientForm() {
        if (this.selectedDoctor && this.selectedDate && this.selectedTime && this.selectedType) {
            // ØªØ­Ø¯ÙŠØ« Ù…Ù„Ø®Øµ Ø§Ù„Ù…ÙˆØ¹Ø¯
            this.updateAppointmentSummary();
            
            // Ù…Ù„Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³Ø¬Ù„Ø§Ù‹
            this.prefillPatientForm();
        }
    }

    /**
     * ØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯
     */
    updateConfirmation() {
        if (this.bookingData) {
            // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙŠ ØµÙØ­Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯
            this.updateConfirmationDetails();
            
            // ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² Ø§Ù„Ø­Ø¬Ø²
            this.generateBookingCode();
        }
    }

    /**
     * ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡
     */
    async loadDoctors() {
        try {
            const doctorsContainer = document.getElementById('doctors-list');
            if (!doctorsContainer) return;
            
            // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            doctorsContainer.innerHTML = `
                <div class="loading-doctors">
                    <div class="spinner"></div>
                    <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡...</p>
                </div>
            `;
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const doctors = await this.db.getAll('doctors', { status: 'active' });
            
            if (doctors.length === 0) {
                doctorsContainer.innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-user-md-slash"></i>
                        <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø·Ø¨Ø§Ø¡ Ù…ØªØ§Ø­ÙŠÙ†</h3>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø·Ø¨Ø§Ø¡ Ù…ØªØ§Ø­ÙŠÙ† Ù„Ù„Ø­Ø¬Ø² ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
                    </div>
                `;
                return;
            }
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡
            doctorsContainer.innerHTML = '';
            doctors.forEach(doctor => {
                const doctorCard = this.createDoctorCard(doctor);
                doctorsContainer.appendChild(doctorCard);
            });
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡:', error);
            
            const doctorsContainer = document.getElementById('doctors-list');
            if (doctorsContainer) {
                doctorsContainer.innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</h3>
                        <p>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</p>
                        <button class="btn btn-primary mt-3" onclick="location.reload()">
                            <i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                        </button>
                    </div>
                `;
            }
        }
    }

    /**
     * Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨
     */
    createDoctorCard(doctor) {
        const card = document.createElement('div');
        card.className = 'doctor-card';
        card.dataset.doctorId = doctor.id;
        
        // ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨
        const isAvailable = this.isDoctorAvailable(doctor);
        const statusClass = isAvailable ? 'available' : 'busy';
        const statusText = isAvailable ? 'Ù…ØªØ§Ø­' : 'Ù…Ø´ØºÙˆÙ„';
        
        // ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„
        const scheduleDays = doctor.schedule?.map(s => s.day).join('ØŒ ') || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        
        card.innerHTML = `
            <div class="doctor-status ${statusClass}">${statusText}</div>
            <div class="doctor-header">
                <div class="doctor-avatar">
                    <i class="fas fa-user-md"></i>
                </div>
                <div class="doctor-info">
                    <h3 class="doctor-name">${doctor.name}</h3>
                    <span class="doctor-specialty">${doctor.specialty}</span>
                    <div class="doctor-experience">
                        <i class="fas fa-briefcase"></i>
                        <span>${doctor.experience || 'Ø®Ø¨Ø±Ø©'}</span>
                    </div>
                </div>
            </div>
            <div class="doctor-details">
                <div class="doctor-schedule">
                    <i class="fas fa-calendar-alt"></i>
                    <span>${scheduleDays}</span>
                </div>
                <div class="doctor-fee">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>${this.formatCurrency(doctor.consultationFee || 0)}</span>
                </div>
            </div>
        `;
        
        // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø±
        if (isAvailable) {
            card.addEventListener('click', () => this.selectDoctor(doctor, card));
            card.style.cursor = 'pointer';
        } else {
            card.style.opacity = '0.7';
            card.style.cursor = 'not-allowed';
        }
        
        return card;
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„Ø·Ø¨ÙŠØ¨
     */
    isDoctorAvailable(doctor) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨
        if (doctor.status !== 'active') return false;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ø¯ÙˆÙ„ Ø¹Ù…Ù„
        if (!doctor.schedule || doctor.schedule.length === 0) return false;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£ÙŠØ§Ù… Ø¹Ù…Ù„ Ù…ØªØ§Ø­Ø©
        const today = new Date();
        const todayName = this.getArabicDayName(today);
        
        const todaySchedule = doctor.schedule.find(s => s.day === todayName);
        return todaySchedule?.isAvailable || false;
    }

    /**
     * Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø¨ÙŠØ¨
     */
    selectDoctor(doctor, cardElement) {
        // Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø³Ø§Ø¨Ù‚
        const previouslySelected = document.querySelector('.doctor-card.selected');
        if (previouslySelected) {
            previouslySelected.classList.remove('selected');
        }
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        this.selectedDoctor = doctor;
        cardElement.classList.add('selected');
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø± Ø§Ù„ØªØ§Ù„ÙŠ
        this.updateStepButtons();
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
        this.showToast(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙƒØªÙˆØ± ${doctor.name}`, 'success');
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø®ØªØ§Ø±
     */
    updateSelectedDoctorInfo() {
        const container = document.getElementById('selected-doctor-info');
        if (!container || !this.selectedDoctor) return;
        
        container.innerHTML = `
            <h4><i class="fas fa-user-md"></i> Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø®ØªØ§Ø±</h4>
            <div class="doctor-detail">
                <i class="fas fa-user"></i>
                <span>${this.selectedDoctor.name}</span>
            </div>
            <div class="doctor-detail">
                <i class="fas fa-stethoscope"></i>
                <span>${this.selectedDoctor.specialty}</span>
            </div>
            <div class="doctor-detail">
                <i class="fas fa-clock"></i>
                <span>${this.selectedDoctor.experience || 'Ø®Ø¨Ø±Ø©'}</span>
            </div>
            <div class="doctor-detail">
                <i class="fas fa-money-bill-wave"></i>
                <span>${this.formatCurrency(this.selectedDoctor.consultationFee || 0)}</span>
            </div>
        `;
    }

    /**
     * ØªØ­Ù…ÙŠÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
     */
    loadAppointmentTypes() {
        const container = document.getElementById('type-options');
        if (!container) return;
        
        const appointmentTypes = this.config?.get('APPOINTMENT_TYPES') || [
            { id: 'checkup', name: 'ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯', duration: 30, price: 0 },
            { id: 'followup', name: 'Ù…ØªØ§Ø¨Ø¹Ø©', duration: 20, price: 0 },
            { id: 'consultation', name: 'Ø§Ø³ØªØ´Ø§Ø±Ø©', duration: 45, price: 0 },
            { id: 'emergency', name: 'Ø·ÙˆØ§Ø±Ø¦', duration: 60, price: 50 },
            { id: 'surgery', name: 'Ø¬Ø±Ø§Ø­Ø©', duration: 120, price: 100 }
        ];
        
        container.innerHTML = '';
        appointmentTypes.forEach(type => {
            const option = document.createElement('div');
            option.className = 'type-option';
            option.dataset.typeId = type.id;
            
            option.innerHTML = `
                <div class="type-name">${type.name}</div>
                <div class="type-duration">${type.duration} Ø¯Ù‚ÙŠÙ‚Ø©</div>
                <div class="type-price">${type.price > 0 ? `+ ${this.formatCurrency(type.price)}` : 'Ù…Ø´Ù…ÙˆÙ„'}</div>
            `;
            
            option.addEventListener('click', () => this.selectAppointmentType(type, option));
            container.appendChild(option);
        });
    }

    /**
     * Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ¹Ø¯
     */
    selectAppointmentType(type, element) {
        // Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø³Ø§Ø¨Ù‚
        const previouslySelected = document.querySelector('.type-option.selected');
        if (previouslySelected) {
            previouslySelected.classList.remove('selected');
        }
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        this.selectedType = type;
        element.classList.add('selected');
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø± Ø§Ù„ØªØ§Ù„ÙŠ
        this.updateStepButtons();
    }

    /**
     * Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…
     */
    setupCalendar() {
        // Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
        this.currentMonth = new Date().getMonth();
        this.currentYear = new Date().getFullYear();
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡Ø±
        this.updateCalendar();
        
        // Ø£Ø­Ø¯Ø§Ø« Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø´Ù‡ÙˆØ±
        const prevMonthBtn = document.querySelector('.prev-month');
        const nextMonthBtn = document.querySelector('.next-month');
        
        if (prevMonthBtn) {
            prevMonthBtn.addEventListener('click', () => {
                this.currentMonth--;
                if (this.currentMonth < 0) {
                    this.currentMonth = 11;
                    this.currentYear--;
                }
                this.updateCalendar();
            });
        }
        
        if (nextMonthBtn) {
            nextMonthBtn.addEventListener('click', () => {
                this.currentMonth++;
                if (this.currentMonth > 11) {
                    this.currentMonth = 0;
                    this.currentYear++;
                }
                this.updateCalendar();
            });
        }
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚ÙˆÙŠÙ…
     */
    updateCalendar() {
        const monthNames = [
            'ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ',
            'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'
        ];
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ù‡Ø±
        const monthTitle = document.getElementById('current-month');
        if (monthTitle) {
            monthTitle.textContent = `${monthNames[this.currentMonth]} ${this.currentYear}`;
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠØ§Ù… Ø§Ù„Ø´Ù‡Ø±
        this.renderCalendarDays();
    }

    /**
     * Ø¹Ø±Ø¶ Ø£ÙŠØ§Ù… Ø§Ù„ØªÙ‚ÙˆÙŠÙ…
     */
    renderCalendarDays() {
        const container = document.getElementById('calendar-days');
        if (!container) return;
        
        container.innerHTML = '';
        
        // Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙˆÙ„ Ù…Ù† Ø§Ù„Ø´Ù‡Ø±
        const firstDay = new Date(this.currentYear, this.currentMonth, 1);
        // Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø£Ø®ÙŠØ± Ù…Ù† Ø§Ù„Ø´Ù‡Ø±
        const lastDay = new Date(this.currentYear, this.currentMonth + 1, 0);
        // Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… ÙÙŠ Ø§Ù„Ø´Ù‡Ø±
        const daysInMonth = lastDay.getDate();
        // ÙŠÙˆÙ… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„ (0 = Ø§Ù„Ø£Ø­Ø¯)
        const firstDayIndex = firstDay.getDay();
        
        // Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ÙØ§Ø±ØºØ© Ù‚Ø¨Ù„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø±
        for (let i = 0; i < firstDayIndex; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day empty';
            container.appendChild(emptyDay);
        }
        
        // Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ÙØ¹Ù„ÙŠØ©
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(this.currentYear, this.currentMonth, day);
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.textContent = day;
            dayElement.dataset.date = date.toISOString().split('T')[0];
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙŠÙˆÙ… Ù‡Ùˆ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
            if (date.getTime() === today.getTime()) {
                dayElement.classList.add('today');
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙŠ Ø§Ù„Ù…Ø§Ø¶ÙŠ
            if (date < today) {
                dayElement.classList.add('disabled');
            } else {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø®ØªØ§Ø±
                if (this.selectedDoctor) {
                    const isAvailable = this.isDateAvailableForDoctor(date);
                    if (isAvailable) {
                        dayElement.classList.add('available');
                        dayElement.addEventListener('click', () => this.selectDate(date, dayElement));
                    } else {
                        dayElement.classList.add('disabled');
                    }
                } else {
                    dayElement.classList.add('available');
                    dayElement.addEventListener('click', () => this.selectDate(date, dayElement));
                }
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ù‡Ùˆ Ø§Ù„Ù…Ø®ØªØ§Ø±
            if (this.selectedDate && date.toISOString().split('T')[0] === this.selectedDate) {
                dayElement.classList.add('selected');
            }
            
            container.appendChild(dayElement);
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø·Ø¨ÙŠØ¨
        this.updateAvailableDays();
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù„Ø·Ø¨ÙŠØ¨
     */
    isDateAvailableForDoctor(date) {
        if (!this.selectedDoctor || !this.selectedDoctor.schedule) return true;
        
        const dayName = this.getArabicDayName(date);
        const doctorSchedule = this.selectedDoctor.schedule.find(s => s.day === dayName);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙŠØ¹Ù…Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…
        if (!doctorSchedule || !doctorSchedule.isAvailable) {
            return false;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„ÙŠØ³ ÙÙŠ Ø¹Ø·Ù„Ø©
        const holidays = this.config?.get('BUSINESS.HOLIDAYS') || [];
        const dateString = date.toISOString().split('T')[0];
        
        if (holidays.includes(dateString)) {
            return false;
        }
        
        return true;
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…ØªØ§Ø­Ø©
     */
    updateAvailableDays() {
        const container = document.getElementById('available-days');
        if (!container || !this.selectedDoctor) return;
        
        const schedule = this.selectedDoctor.schedule || [];
        const availableDays = schedule.filter(s => s.isAvailable).map(s => s.day);
        
        container.innerHTML = '';
        availableDays.forEach(day => {
            const dayElement = document.createElement('div');
            dayElement.className = 'available-day';
            dayElement.textContent = day;
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙŠÙˆÙ… Ù‡Ùˆ Ø§Ù„Ù…Ø®ØªØ§Ø±
            if (this.selectedDate) {
                const selectedDayName = this.getArabicDayName(new Date(this.selectedDate));
                if (day === selectedDayName) {
                    dayElement.classList.add('selected');
                }
            }
            
            dayElement.addEventListener('click', () => {
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ ØªØ§Ø±ÙŠØ® Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…
                this.selectDayByName(day);
            });
            
            container.appendChild(dayElement);
        });
    }

    /**
     * Ø§Ø®ØªÙŠØ§Ø± ÙŠÙˆÙ… Ø¨Ø§Ù„Ø§Ø³Ù…
     */
    selectDayByName(dayName) {
        const today = new Date();
        let foundDate = null;
        
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ ØªØ§Ø±ÙŠØ® ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…
        for (let i = 0; i < 30; i++) { // Ø§Ù„Ø¨Ø­Ø« Ù„Ù…Ø¯Ø© Ø´Ù‡Ø±
            const date = new Date();
            date.setDate(today.getDate() + i);
            
            if (this.getArabicDayName(date) === dayName && 
                this.isDateAvailableForDoctor(date)) {
                foundDate = date;
                break;
            }
        }
        
        if (foundDate) {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ù‡Ø± Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
            if (foundDate.getMonth() !== this.currentMonth || 
                foundDate.getFullYear() !== this.currentYear) {
                this.currentMonth = foundDate.getMonth();
                this.currentYear = foundDate.getFullYear();
                this.updateCalendar();
            }
            
            // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®
            const dateString = foundDate.toISOString().split('T')[0];
            const dayElement = document.querySelector(`.calendar-day[data-date="${dateString}"]`);
            if (dayElement) {
                this.selectDate(foundDate, dayElement);
            }
        }
    }

    /**
     * Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®
     */
    selectDate(date, element) {
        // Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø§Ø¨Ù‚
        const previouslySelected = document.querySelector('.calendar-day.selected');
        if (previouslySelected) {
            previouslySelected.classList.remove('selected');
        }
        
        // Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        const previouslySelectedDays = document.querySelectorAll('.available-day.selected');
        previouslySelectedDays.forEach(day => day.classList.remove('selected'));
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¬Ø¯ÙŠØ¯
        this.selectedDate = date.toISOString().split('T')[0];
        element.classList.add('selected');
        
        // ØªØ­Ø¯ÙŠØ¯ ÙŠÙˆÙ… Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
        const dayName = this.getArabicDayName(date);
        const dayElement = Array.from(document.querySelectorAll('.available-day'))
            .find(el => el.textContent === dayName);
        if (dayElement) {
            dayElement.classList.add('selected');
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø± Ø§Ù„ØªØ§Ù„ÙŠ
        this.updateStepButtons();
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
        const formattedDate = date.toLocaleDateString('ar-EG', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        this.showToast(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®: ${formattedDate}`, 'success');
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø¨Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ø¨ÙŠØ¨
     */
    updateCalendarWithDoctorSchedule() {
        this.updateCalendar();
        this.updateSelectedDoctorInfo();
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø®ØªØ§Ø±
     */
    updateSelectedDateInfo() {
        if (!this.selectedDate) return;
        
        const date = new Date(this.selectedDate);
        const formattedDate = date.toLocaleDateString('ar-EG', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ© 3
        const doctorName = document.getElementById('selected-doctor-name');
        const selectedDate = document.getElementById('selected-date');
        const selectedDay = document.getElementById('selected-day');
        
        if (doctorName) {
            doctorName.textContent = this.selectedDoctor?.name || '-';
        }
        
        if (selectedDate) {
            selectedDate.textContent = formattedDate;
        }
        
        if (selectedDay) {
            selectedDay.textContent = this.getArabicDayName(date);
        }
    }

    /**
     * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
     */
    async loadAvailableTimeSlots() {
        const container = document.getElementById('time-slots');
        const noSlots = document.getElementById('no-slots');
        if (!container || !noSlots) return;
        
        // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        container.innerHTML = `
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©...</p>
            </div>
        `;
        
        try {
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„
            const workingHours = this.config?.get('BUSINESS.WORKING_HOURS') || {
                START: '08:00',
                END: '20:00'
            };
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø©
            const appointments = await this.db.getAll('appointments', {
                doctorId: this.selectedDoctor?.id,
                date: this.selectedDate,
                status: { operator: 'in', value: ['Ù…Ø¬Ø¯ÙˆÙ„', 'Ù…Ø¤ÙƒØ¯'] }
            });
            
            // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
            const availableSlots = this.generateTimeSlots(
                workingHours.START,
                workingHours.END,
                this.selectedDoctor?.schedule,
                appointments
            );
            
            if (availableSlots.length === 0) {
                container.style.display = 'none';
                noSlots.style.display = 'block';
                return;
            }
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
            container.style.display = 'grid';
            noSlots.style.display = 'none';
            container.innerHTML = '';
            
            availableSlots.forEach(slot => {
                const slotElement = document.createElement('div');
                slotElement.className = 'time-slot';
                slotElement.textContent = slot.time;
                slotElement.dataset.time = slot.time;
                
                if (slot.available) {
                    slotElement.addEventListener('click', () => this.selectTime(slot.time, slotElement));
                } else {
                    slotElement.classList.add('disabled');
                    slotElement.title = 'Ù…Ø­Ø¬ÙˆØ²';
                }
                
                container.appendChild(slotElement);
            });
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª:', error);
            container.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª</h3>
                    <p>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</p>
                </div>
            `;
        }
    }

    /**
     * ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
     */
    generateTimeSlots(startTime, endTime, doctorSchedule, appointments) {
        const slots = [];
        const appointmentDuration = this.config?.get('BUSINESS.APPOINTMENT_DURATION') || 30;
        
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø¥Ù„Ù‰ Ø¯Ù‚Ø§Ø¦Ù‚
        const startMinutes = this.timeToMinutes(startTime);
        const endMinutes = this.timeToMinutes(endTime);
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙˆÙ‚Øª Ø±Ø§Ø­Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨
        const dayName = this.getArabicDayName(new Date(this.selectedDate));
        const schedule = doctorSchedule?.find(s => s.day === dayName);
        
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙŠØ¹Ù…Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…
        if (!schedule || !schedule.isAvailable) {
            return [];
        }
        
        const scheduleStart = this.timeToMinutes(schedule.from);
        const scheduleEnd = this.timeToMinutes(schedule.to);
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø©
        const bookedSlots = appointments.map(app => this.timeToMinutes(app.time));
        
        // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª
        for (let time = Math.max(startMinutes, scheduleStart); 
             time <= Math.min(endMinutes, scheduleEnd); 
             time += appointmentDuration) {
            
            // ØªØ®Ø·ÙŠ ÙˆÙ‚Øª Ø§Ù„Ø±Ø§Ø­Ø©
            const breakStart = this.timeToMinutes('12:00');
            const breakEnd = this.timeToMinutes('13:00');
            if (time >= breakStart && time < breakEnd) {
                continue;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…ÙˆØ¹Ø¯ Ù…Ø­Ø¬ÙˆØ² ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª
            const isBooked = bookedSlots.some(bookedTime => 
                Math.abs(bookedTime - time) < appointmentDuration
            );
            
            const timeString = this.minutesToTime(time);
            slots.push({
                time: timeString,
                available: !isBooked
            });
        }
        
        return slots;
    }

    /**
     * ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ø¥Ù„Ù‰ Ø¯Ù‚Ø§Ø¦Ù‚
     */
    timeToMinutes(time) {
        if (!time) return 0;
        const [hours, minutes] = time.split(':').map(Number);
        return hours * 60 + (minutes || 0);
    }

    /**
     * ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ Ø¥Ù„Ù‰ ÙˆÙ‚Øª
     */
    minutesToTime(minutes) {
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
    }

    /**
     * Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆÙ‚Øª
     */
    selectTime(time, element) {
        // Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø³Ø§Ø¨Ù‚
        const previouslySelected = document.querySelector('.time-slot.selected');
        if (previouslySelected) {
            previouslySelected.classList.remove('selected');
        }
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯
        this.selectedTime = time;
        element.classList.add('selected');
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø± Ø§Ù„ØªØ§Ù„ÙŠ
        this.updateStepButtons();
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
        this.showToast(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆÙ‚Øª: ${time}`, 'success');
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ù…Ù„Ø®Øµ Ø§Ù„Ù…ÙˆØ¹Ø¯
     */
    updateAppointmentSummary() {
        const summaryDoctor = document.getElementById('summary-doctor');
        const summaryDate = document.getElementById('summary-date');
        const summaryTime = document.getElementById('summary-time');
        const summaryType = document.getElementById('summary-type');
        const summaryFee = document.getElementById('summary-fee');
        
        if (summaryDoctor) {
            summaryDoctor.textContent = this.selectedDoctor?.name || '-';
        }
        
        if (summaryDate && this.selectedDate) {
            const date = new Date(this.selectedDate);
            summaryDate.textContent = date.toLocaleDateString('ar-EG', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
        
        if (summaryTime) {
            summaryTime.textContent = this.selectedTime || '-';
        }
        
        if (summaryType) {
            summaryType.textContent = this.selectedType?.name || '-';
        }
        
        if (summaryFee) {
            summaryFee.textContent = this.bookingData.formattedFee || '-';
        }
    }

    /**
     * Ù…Ù„Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø±ÙŠØ¶ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
     */
    prefillPatientForm() {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„Ø§Ù‹ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ ÙŠÙ…ÙƒÙ† Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        const currentUser = this.db?.getCurrentUser();
        if (currentUser && currentUser.role === 'patient') {
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
            const patients = this.db.getAll('patients', { email: currentUser.email });
            if (patients.length > 0) {
                const patient = patients[0];
                this.fillPatientForm(patient);
            }
        }
    }

    /**
     * Ù…Ù„Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø±ÙŠØ¶
     */
    fillPatientForm(patientData) {
        const form = document.getElementById('patient-form');
        if (!form) return;
        
        // Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„
        Object.keys(patientData).forEach(key => {
            const field = form.querySelector(`[name="${key}"]`);
            if (field) {
                field.value = patientData[key] || '';
            }
        });
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        const birthDateField = form.querySelector('[name="birthDate"]');
        const ageField = form.querySelector('[name="age"]');
        
        if (birthDateField && ageField && birthDateField.value) {
            const birthDate = new Date(birthDateField.value);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            ageField.value = age;
        }
    }

    /**
     * ØªØ­Ø¯ÙŠØ« ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ£ÙƒÙŠØ¯
     */
    updateConfirmationDetails() {
        // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨
        const confirmDoctor = document.getElementById('confirm-doctor');
        const confirmSpecialty = document.getElementById('confirm-specialty');
        const confirmFee = document.getElementById('confirm-fee');
        
        if (confirmDoctor) confirmDoctor.textContent = this.selectedDoctor?.name || '-';
        if (confirmSpecialty) confirmSpecialty.textContent = this.selectedDoctor?.specialty || '-';
        if (confirmFee) confirmFee.textContent = this.bookingData.formattedFee || '-';
        
        // ØªÙˆÙ‚ÙŠØª Ø§Ù„Ù…ÙˆØ¹Ø¯
        const confirmDate = document.getElementById('confirm-date');
        const confirmDay = document.getElementById('confirm-day');
        const confirmTime = document.getElementById('confirm-time');
        
        if (confirmDate) confirmDate.textContent = this.bookingData.formattedDate || '-';
        if (confirmDay) confirmDay.textContent = this.bookingData.dayName || '-';
        if (confirmTime) confirmTime.textContent = this.selectedTime || '-';
        
        // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
        const confirmPatient = document.getElementById('confirm-patient');
        const confirmPhone = document.getElementById('confirm-phone');
        const confirmType = document.getElementById('confirm-type');
        
        if (confirmPatient) confirmPatient.textContent = this.patientData.fullName || '-';
        if (confirmPhone) confirmPhone.textContent = this.patientData.phone || '-';
        if (confirmType) confirmType.textContent = this.selectedType?.name || '-';
        
        // Ù…Ù„Ø§Ø­Ø¸Ø§Øª
        const confirmReason = document.getElementById('confirm-reason');
        if (confirmReason) confirmReason.textContent = this.patientData.reason || '-';
        
        // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº
        const totalFee = document.getElementById('total-fee');
        if (totalFee) totalFee.textContent = this.bookingData.formattedFee || '-';
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        this.setupConfirmationButtons();
    }

    /**
     * ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² Ø§Ù„Ø­Ø¬Ø²
     */
    generateBookingCode() {
        const bookingCode = document.getElementById('booking-code');
        if (bookingCode) {
            const timestamp = Date.now().toString(36).toUpperCase();
            const random = Math.random().toString(36).substring(2, 6).toUpperCase();
            const code = `BK${timestamp}${random}`;
            bookingCode.textContent = code;
            this.bookingData.code = code;
        }
    }

    /**
     * Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø­Ø¯Ø§Ø« Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯
     */
    setupConfirmationButtons() {
        // Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        const editButton = document.getElementById('edit-booking');
        if (editButton) {
            editButton.addEventListener('click', () => {
                this.goToStep(1);
            });
        }
        
        // Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯
        const confirmButton = document.getElementById('confirm-booking');
        if (confirmButton) {
            confirmButton.addEventListener('click', () => {
                this.confirmBooking();
            });
        }
        
        // Ø²Ø± Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const newBookingButton = document.getElementById('new-booking');
        if (newBookingButton) {
            newBookingButton.addEventListener('click', () => {
                this.resetBooking();
            });
        }
    }

    /**
     * ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²
     */
    async confirmBooking() {
        try {
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
            const bookingData = {
                patientId: this.generatePatientId(),
                doctorId: this.selectedDoctor.id,
                doctorName: this.selectedDoctor.name,
                patientName: this.patientData.fullName,
                patientPhone: this.patientData.phone,
                date: this.selectedDate,
                time: this.selectedTime,
                type: this.selectedType.name,
                reason: this.patientData.reason,
                notes: this.patientData.notes,
                fee: this.bookingData.fee,
                status: 'Ù…Ø¬Ø¯ÙˆÙ„',
                paymentStatus: 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹',
                code: this.bookingData.code
            };
            
            // Ø­ÙØ¸ Ø§Ù„Ù…Ø±ÙŠØ¶ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            await this.savePatientToDatabase();
            
            // Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const result = await this.db.bookAppointment(bookingData);
            
            if (result.success) {
                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
                this.showBookingSuccess(result.data);
                
                // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯
                const confirmButton = document.getElementById('confirm-booking');
                const newBookingButton = document.getElementById('new-booking');
                
                if (confirmButton) confirmButton.style.display = 'none';
                if (newBookingButton) newBookingButton.style.display = 'block';
                
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·ÙˆØ©
                this.markStepAsCompleted(5);
                
            } else {
                throw new Error(result.message || 'ÙØ´Ù„ ÙÙŠ Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ¹Ø¯');
            }
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²:', error);
            this.showToast('ÙØ´Ù„ ÙÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²: ' + error.message, 'error');
        }
    }

    /**
     * ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø±ÙŠØ¶
     */
    generatePatientId() {
        return `PAT${Date.now().toString(36)}${Math.random().toString(36).substring(2, 6)}`;
    }

    /**
     * Ø­ÙØ¸ Ø§Ù„Ù…Ø±ÙŠØ¶ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
     */
    async savePatientToDatabase() {
        try {
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            const existingPatients = await this.db.getAll('patients', {
                phone: this.patientData.phone
            });
            
            if (existingPatients.length === 0) {
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯
                const patientData = {
                    fullName: this.patientData.fullName,
                    phone: this.patientData.phone,
                    email: this.patientData.email,
                    gender: this.patientData.gender,
                    birthDate: this.patientData.birthDate,
                    age: this.patientData.age,
                    address: this.patientData.address,
                    bloodType: this.patientData.bloodType,
                    allergies: this.patientData.allergies,
                    chronicDiseases: this.patientData.chronicDiseases
                };
                
                await this.db.create('patients', patientData);
            }
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶:', error);
            // Ù„Ø§ Ù†ÙˆÙ‚Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø£Ù† Ø­ÙØ¸ Ø§Ù„Ù…Ø±ÙŠØ¶ Ù„ÙŠØ³ Ø¶Ø±ÙˆØ±ÙŠØ§Ù‹ Ù„Ù„Ø­Ø¬Ø²
        }
    }

    /**
     * Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ø§Ù„Ø­Ø¬Ø²
     */
    showBookingSuccess(bookingData) {
        // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
        const successHTML = `
            <div class="booking-success">
                <i class="fas fa-check-circle"></i>
                <h3>ØªÙ… Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­!</h3>
                <p>
                    ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯Ùƒ Ù…Ø¹ ${bookingData.doctorName}<br>
                    Ø§Ù„ØªØ§Ø±ÙŠØ®: ${bookingData.date} | Ø§Ù„ÙˆÙ‚Øª: ${bookingData.time}<br>
                    Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²: <strong>${bookingData.code}</strong>
                </p>
                <div class="booking-actions">
                    <button class="btn btn-primary" onclick="window.print()">
                        <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯
                    </button>
                    <button class="btn btn-outline" onclick="window.location.href='dashboard.html'">
                        <i class="fas fa-tachometer-alt"></i> Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                    </button>
                </div>
                <p class="mt-4 text-muted">
                    Ø³ØªØµÙ„Ùƒ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø¹Ù„Ù‰ Ù‡Ø§ØªÙÙƒ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù€ 24 Ø³Ø§Ø¹Ø©
                </p>
            </div>
        `;
        
        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù…Ø­ØªÙˆÙ‰ Ø®Ø·ÙˆØ© Ø§Ù„ØªØ£ÙƒÙŠØ¯
        const stepContent = document.querySelector('.wizard-step-content[data-step="5"]');
        if (stepContent) {
            const confirmationContainer = stepContent.querySelector('.confirmation-container');
            if (confirmationContainer) {
                confirmationContainer.innerHTML = successHTML;
            }
        }
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­
        this.showToast('ØªÙ… Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
    }

    /**
     * Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø¬Ø²
     */
    resetBooking() {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        this.currentStep = 1;
        this.selectedDoctor = null;
        this.selectedDate = null;
        this.selectedTime = null;
        this.selectedType = null;
        this.patientData = {};
        this.bookingData = {};
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        this.resetUI();
        
        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰
        this.goToStep(1);
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø©
        this.showToast('ØªÙ… Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯Ø©', 'info');
    }

    /**
     * Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
     */
    resetUI() {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡
        const doctorCards = document.querySelectorAll('.doctor-card.selected');
        doctorCards.forEach(card => card.classList.remove('selected'));
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
        const dateElements = document.querySelectorAll('.calendar-day.selected, .available-day.selected');
        dateElements.forEach(el => el.classList.remove('selected'));
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£ÙˆÙ‚Ø§Øª
        const timeSlots = document.querySelectorAll('.time-slot.selected');
        timeSlots.forEach(slot => slot.classList.remove('selected'));
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
        const typeOptions = document.querySelectorAll('.type-option.selected');
        typeOptions.forEach(option => option.classList.remove('selected'));
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
        const forms = document.querySelectorAll('form');
        forms.forEach(form => form.reset());
    }

    /**
     * ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø®Ø·ÙˆØ© ÙƒÙ…ÙƒØªÙ…Ù„Ø©
     */
    markStepAsCompleted(stepNumber) {
        const step = document.querySelector(`.wizard-step[data-step="${stepNumber}"]`);
        if (step) {
            step.classList.add('completed');
        }
    }

    /**
     * Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø³Ø±ÙŠØ¹
     */
    async setupQuickBooking() {
        const quickBooking = document.getElementById('quick-booking');
        if (!quickBooking) return;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        const currentUser = this.db?.getCurrentUser();
        if (currentUser) {
            quickBooking.style.display = 'block';
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ Ù„Ù„Ø­Ø¬Ø² Ø§Ù„Ø³Ø±ÙŠØ¹
            await this.loadQuickBookingDoctors();
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø³Ø±ÙŠØ¹
            this.setupQuickBookingEvents();
        }
    }

    /**
     * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ Ù„Ù„Ø­Ø¬Ø² Ø§Ù„Ø³Ø±ÙŠØ¹
     */
    async loadQuickBookingDoctors() {
        const select = document.getElementById('quick-doctor');
        if (!select) return;
        
        try {
            const doctors = await this.db.getAll('doctors', { status: 'active' });
            
            select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø¨ÙŠØ¨</option>';
            doctors.forEach(doctor => {
                const option = document.createElement('option');
                option.value = doctor.id;
                option.textContent = `${doctor.name} - ${doctor.specialty}`;
                select.appendChild(option);
            });
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ Ù„Ù„Ø­Ø¬Ø² Ø§Ù„Ø³Ø±ÙŠØ¹:', error);
        }
    }

    /**
     * Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø³Ø±ÙŠØ¹
     */
    setupQuickBookingEvents() {
        const quickBookBtn = document.getElementById('quick-book-btn');
        if (quickBookBtn) {
            quickBookBtn.addEventListener('click', () => {
                this.processQuickBooking();
            });
        }
        
        // Ø­Ø¯Ø« ØªØºÙŠÙŠØ± Ø§Ù„ØªØ§Ø±ÙŠØ®
        const dateInput = document.getElementById('quick-date');
        if (dateInput) {
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„ÙŠÙˆÙ…)
            const today = new Date().toISOString().split('T')[0];
            dateInput.min = today;
            
            dateInput.addEventListener('change', () => {
                this.loadQuickBookingTimes();
            });
        }
        
        // Ø­Ø¯Ø« ØªØºÙŠÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ¨
        const doctorSelect = document.getElementById('quick-doctor');
        if (doctorSelect) {
            doctorSelect.addEventListener('change', () => {
                this.loadQuickBookingTimes();
            });
        }
    }

    /**
     * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ù„Ù„Ø­Ø¬Ø² Ø§Ù„Ø³Ø±ÙŠØ¹
     */
    async loadQuickBookingTimes() {
        const doctorSelect = document.getElementById('quick-doctor');
        const dateInput = document.getElementById('quick-date');
        const timeSelect = document.getElementById('quick-time');
        
        if (!doctorSelect || !dateInput || !timeSelect) return;
        
        const doctorId = doctorSelect.value;
        const date = dateInput.value;
        
        if (!doctorId || !date) {
            timeSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ‚Øª</option>';
            return;
        }
        
        try {
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨
            const doctor = await this.db.getById('doctors', doctorId);
            if (!doctor) return;
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø©
            const appointments = await this.db.getAll('appointments', {
                doctorId: doctorId,
                date: date,
                status: { operator: 'in', value: ['Ù…Ø¬Ø¯ÙˆÙ„', 'Ù…Ø¤ÙƒØ¯'] }
            });
            
            // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
            const workingHours = this.config?.get('BUSINESS.WORKING_HOURS') || {
                START: '08:00',
                END: '20:00'
            };
            
            const availableSlots = this.generateTimeSlots(
                workingHours.START,
                workingHours.END,
                doctor.schedule,
                appointments
            );
            
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆÙ‚Ø§Øª
            timeSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ‚Øª</option>';
            availableSlots.forEach(slot => {
                if (slot.available) {
                    const option = document.createElement('option');
                    option.value = slot.time;
                    option.textContent = slot.time;
                    timeSelect.appendChild(option);
                }
            });
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ù„Ù„Ø­Ø¬Ø² Ø§Ù„Ø³Ø±ÙŠØ¹:', error);
        }
    }

    /**
     * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø³Ø±ÙŠØ¹
     */
    async processQuickBooking() {
        const doctorSelect = document.getElementById('quick-doctor');
        const dateInput = document.getElementById('quick-date');
        const timeSelect = document.getElementById('quick-time');
        
        if (!doctorSelect || !dateInput || !timeSelect) return;
        
        const doctorId = doctorSelect.value;
        const date = dateInput.value;
        const time = timeSelect.value;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!doctorId || !date || !time) {
            this.showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª', 'warning');
            return;
        }
        
        try {
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨
            const doctor = await this.db.getById('doctors', doctorId);
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²
            const currentUser = this.db.getCurrentUser();
            
            const bookingData = {
                patientId: currentUser.id,
                doctorId: doctorId,
                doctorName: doctor.name,
                patientName: currentUser.fullName,
                patientPhone: currentUser.phone,
                date: date,
                time: time,
                type: 'ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯',
                reason: 'Ø­Ø¬Ø² Ø³Ø±ÙŠØ¹',
                fee: doctor.consultationFee || 0,
                status: 'Ù…Ø¬Ø¯ÙˆÙ„',
                paymentStatus: 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹'
            };
            
            // Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ¹Ø¯
            const result = await this.db.bookAppointment(bookingData);
            
            if (result.success) {
                this.showToast('ØªÙ… Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø³Ø±ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                doctorSelect.value = '';
                dateInput.value = '';
                timeSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ‚Øª</option>';
                
                // ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1500);
            } else {
                throw new Error(result.message);
            }
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø³Ø±ÙŠØ¹:', error);
            this.showToast('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø³Ø±ÙŠØ¹: ' + error.message, 'error');
        }
    }

    /**
     * Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
     */
    setupFormEvents() {
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø± Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯
        const birthDateField = document.getElementById('patient-birthdate');
        const ageField = document.getElementById('patient-age');
        
        if (birthDateField && ageField) {
            birthDateField.addEventListener('change', () => {
                if (birthDateField.value) {
                    const birthDate = new Date(birthDateField.value);
                    const today = new Date();
                    let age = today.getFullYear() - birthDate.getFullYear();
                    const monthDiff = today.getMonth() - birthDate.getMonth();
                    
                    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                        age--;
                    }
                    
                    ageField.value = age;
                } else {
                    ageField.value = '';
                }
            });
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
        const patientForm = document.getElementById('patient-form');
        if (patientForm) {
            const inputs = patientForm.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    this.updateStepButtons();
                });
            });
        }
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ø¬Ø²
     */
    updateWizardDisplay() {
        const wizardSteps = document.querySelector('.wizard-steps');
        if (!wizardSteps) return;
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©
        if (window.innerWidth < 768) {
            wizardSteps.style.flexDirection = 'column';
            wizardSteps.style.alignItems = 'center';
            wizardSteps.style.gap = 'var(--space-md)';
        } else {
            wizardSteps.style.flexDirection = 'row';
            wizardSteps.style.alignItems = 'normal';
            wizardSteps.style.gap = '0';
        }
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
     */
    getArabicDayName(date) {
        const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
        return days[date.getDay()];
    }

    /**
     * ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„Ø©
     */
    formatCurrency(amount) {
        if (this.config) {
            return this.config.formatCurrency(amount);
        }
        return `${parseFloat(amount).toFixed(2)} Ø¬.Ù…`;
    }

    /**
     * Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø±
     */
    showToast(message, type = 'info') {
        if (window.showToast) {
            window.showToast(message, type);
        } else {
            console.log(`${type}: ${message}`);
        }
    }

    /**
     * Ø¥Ø¸Ù‡Ø§Ø± Ø®Ø·Ø£
     */
    showError(title, message) {
        if (window.showError) {
            window.showError(title, message);
        } else {
            console.error(`${title}: ${message}`);
            alert(`${title}: ${message}`);
        }
    }
}

// ===========================================
// ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¬Ø²
// ===========================================

// Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', () => {
    // Ø¥Ø¹Ø·Ø§Ø¡ ÙˆÙ‚Øª Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    setTimeout(() => {
        // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¬Ø²
        window.bookingSystem = new BookingSystem();
        
        console.log('âœ… Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¬Ø² Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„');
    }, 1000);
});

// Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¥Ø¶Ø§ÙÙŠØ©
window.calculateAge = (birthDate) => {
    if (!birthDate) return '';
    
    const today = new Date();
    const birth = new Date(birthDate);
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
    }
    
    return age;
};

window.formatBookingDate = (dateString) => {
    if (!dateString) return '';
    
    const date = new Date(dateString);
    return date.toLocaleDateString('ar-EG', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
};

// Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù
console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ booking.js Ø¨Ù†Ø¬Ø§Ø­');
